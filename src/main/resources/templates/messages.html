<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8" />
    <title>Tin nhắn | Tourify</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <style>
        body { background: #f4f6fa; }
        .sidebar { border-right: 1.5px solid #eaeaea; background: #fff; height: 90vh; overflow-y: auto; }
        .user-item { cursor:pointer; padding:15px 12px; display:flex; align-items:center; gap:12px; border-bottom:1px solid #f6f6f6; }
        .user-item.active, .user-item:hover { background: #e8f7f3; }
        .avatar { width:44px;height:44px;object-fit:cover;border-radius:50%; }
        .chatbox { background: #fdfdfd; height: 90vh; display: flex; flex-direction: column;}
        .chat-header { padding:14px 20px; border-bottom: 1px solid #ececec; display:flex; align-items:center; gap:12px; }
        .chat-messages { flex:1; overflow-y:auto; padding:24px 20px 10px 20px; background: #f4f6fa;}
        .msg-row { display:flex; margin-bottom:18px; }
        .msg-row.mine { flex-direction: row-reverse; }
        .msg-bubble { max-width:60%; padding:10px 16px; border-radius:14px; font-size:15px;}
        .msg-row.mine .msg-bubble { background: #e0f8ee; color: #222;}
        .msg-row:not(.mine) .msg-bubble { background: #20b876; color: #fff;}
        .msg-meta { font-size:12px; color:#bbb; margin: 0 8px; min-width:60px; text-align:left;}
        .msg-row.mine .msg-meta { text-align:right;}
        .chat-input-bar { border-top: 1px solid #ececec; background: #fff; padding:12px 20px; display:flex; gap:10px;}
        .chat-input-bar textarea {flex:1; border-radius: 10px; border:1.5px solid #e0eee8; padding:9px; min-height:36px;}
        .chat-input-bar button {border-radius:50%; background:#20b876; color:#fff; border:none; width:40px;height:40px;display:flex;align-items:center;justify-content:center;font-size:20px;}
        #sidebarContainer .btn:hover {
                        background: #20b876 !important;
                        color: #fff !important;
                        transition: 0.18s;
                                        }

    </style>
</head>
<body>
<div class="container-fluid py-3">
    <div class="row rounded-4 shadow bg-white" style="max-width:1100px;margin:auto;overflow:hidden;">
        <!-- Danh sách user/chat -->
        <div class="col-md-4 sidebar position-relative" id="sidebarContainer">
            <a th:href="@{/landing}" class="btn w-100 mb-3 mt-3 rounded-3 shadow-sm"
               style="font-weight: 500; color: #20b876; background: #e8f7f3; border: none;">
                <i class="fa fa-arrow-left me-2"></i> Quay về Trang Chủ
            </a>
            <div id="userList"></div>
        </div>
        <!-- Khung chat -->
        <div class="col-md-8 chatbox p-0">
            <div class="chat-header" id="chatHeader">
                <img id="chatAvatar" class="avatar" src="https://via.placeholder.com/44"/>
                <div>
                    <div id="chatUserName" class="fw-bold"></div>
                    <div id="chatUserStatus" style="font-size:13px;color:#aaa;"></div>
                </div>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <form class="chat-input-bar" onsubmit="sendMessage(event)">
                <textarea id="msgInput" placeholder="Nhập tin nhắn..."></textarea>
                <button type="submit"><i class="fas fa-paper-plane"></i></button>
            </form>
        </div>
    </div>
</div>
<!-- SockJS, StompJS -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script>
    function parseJwt(token) {
        try { return JSON.parse(atob(token.split('.')[1])); } catch { return {}; }
    }
    const accessToken = localStorage.getItem('accessToken');
    const user = parseJwt(accessToken);
    const myUserId = user && user.userId;
    const myUserName = user && user.userName;

    let stompClient = null;
    let currentChatUser = null;
    let userMap = {}; // id => user

    // ------ 1. Load user list từ API ------
    function loadUserList() {
    fetch('/tourify/api/messages/users', {
        headers: { Authorization: 'Bearer ' + accessToken }
    })
    .then(res => res.json())
    .then(users => {
        const usersArr = users.map(u => ({
            id: u.userId,
            name: u.userName,
            avatar: u.avatar || 'https://via.placeholder.com/44',
            online: u.online
        }));
        renderUserList(usersArr);
        if (usersArr.length > 0) startChat(usersArr[0].id);
    });
}

    function renderUserList(users) {
        const el = document.getElementById('userList');
        el.innerHTML = users.map(u => `
          <div class="user-item" ...>
    <img src="${u.avatar}" class="avatar"/>
    <div>
        <div class="fw-bold">${u.name}</div>
        <div style="font-size:12px; color:${u.online ? '#20b876' : '#bbb'}">
            ${u.online ? 'Online' : 'Offline'}
        </div>
    </div>
</div>

        `).join('');
        users.forEach(u => userMap[u.id] = u);
    }
    window.startChat = startChat; // expose for HTML

    // ------ 2. Khi chọn user, load lịch sử chat ------
    function startChat(userId) {
        if (!userMap[userId]) return;
        currentChatUser = userMap[userId];
        localStorage.setItem('lastChatUserId', userId); // Lưu lại cho lần reload sau

        // Đánh dấu active
        document.querySelectorAll('.user-item').forEach(e => e.classList.remove('active'));
        const activeEl = document.querySelector(`.user-item[data-id="${userId}"]`);
        if(activeEl) activeEl.classList.add('active');
        // Cập nhật header
        document.getElementById('chatAvatar').src = currentChatUser.avatar;
        document.getElementById('chatUserName').textContent = currentChatUser.name;
        document.getElementById('chatUserStatus').textContent = currentChatUser.online ? 'Đang hoạt động' : '';
        // Tải history (API call)
        document.getElementById('chatMessages').innerHTML = '';
        loadHistory(userId);
    }

    // ------ 3. Load lịch sử chat từ API ------
    function loadHistory(userId) {
        fetch(`/tourify/api/messages/history?with=${userId}`, {
            headers: { Authorization: 'Bearer ' + accessToken }
        })
        .then(res => res.json())
        .then(history => {
            document.getElementById('chatMessages').innerHTML = '';
            history.forEach(m => addMessage(m, m.senderId === myUserId));
        });
    }

    // ------ 4. Thêm tin nhắn vào khung chat ------
    function addMessage(msg, mine = false) {
        const chatMessages = document.getElementById('chatMessages');
        chatMessages.innerHTML += `
          <div class="msg-row${mine ? ' mine' : ''}">
            <div class="msg-meta">${mine ? 'Bạn' : (currentChatUser ? currentChatUser.name : '')}</div>
            <div class="msg-bubble">${msg.content}</div>
          </div>
        `;
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // ------ 5. Kết nối Websocket ------
    function connect() {
        const socket = new SockJS('/tourify/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect(
            { Authorization: 'Bearer ' + accessToken },
            function (frame) {
                stompClient.subscribe(`/user/queue/messages`, function (message) {
                    const msg = JSON.parse(message.body);
                    // Nếu đang chat với user này thì show lên
                    if (currentChatUser && msg.senderId === currentChatUser.id) {
                        addMessage(msg, false);
                    } else {
                        // Có thể thêm badge chưa đọc ở sidebar nếu muốn
                    }
                });
            }
        );
    }

    // ------ 6. Gửi tin nhắn ------
    function sendMessage(e) {
        e.preventDefault();
        if (!currentChatUser) return;
        const input = document.getElementById('msgInput');
        const content = input.value.trim();
        if (!content) return;
        stompClient.send(
            "/app/chat.private.send",
            { Authorization: "Bearer " + accessToken },
            JSON.stringify({
                receiverId: currentChatUser.id,
                content: content
            })
        );
        addMessage({ senderId: myUserId, content: content }, true);
        input.value = '';
    }

    // ------ 7. Khởi tạo ------
    loadUserList();
    connect();

</script>

</body>
</html>
